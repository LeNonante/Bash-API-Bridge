<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API-Bash Bridge - Paramètres</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='index.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='settings.css') }}">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-left">
            <a href="/" class="logo-link" style="text-decoration: none;">
                <div class="logo">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="5" width="17" height="14" rx="2" stroke="#22d3ee" stroke-width="2"/>
                        <path d="M7 10L9 12L7 14" stroke="#22d3ee" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 14H16" stroke="#22d3ee" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <span>API-Bash Bridge</span>
                </div>
            </a>
        </div>
        
        <div class="nav-center">
            <a href="/" class="nav-link">Dashboard</a>
            <a href="/settings" class="nav-link active">Paramètres</a>
            <a href="/logout" class="nav-link">Déconnexion</a>
          </div>
      
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <div>
                <h1>Paramètres</h1>
            </div>
        </div>
        <div class="settings-grid">

            <!-- Changer le mot de passe -->
            <div class="login-card settings-card">
                <h2>Changer le mot de passe administrateur</h2>
                <p class="description">Saisissez votre ancien mot de passe, puis le nouveau (deux fois) pour confirmer.</p>

                <form method="post">
                    <input type="hidden" name="action" value="changePassword">
                    <div class="form-group">
                        <label for="current_password">Ancien mot de passe</label>
                        <div class="input-wrapper">
                            <input type="password" id="current_password" name="current_password" placeholder="••••••••" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="new_password1">Nouveau mot de passe</label>
                        <div class="input-wrapper">
                            <input type="password" id="new_password1" name="new_password1" placeholder="••••••••" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="new_password2">Confirmer le nouveau mot de passe</label>
                        <div class="input-wrapper">
                            <input type="password" id="new_password2" name="new_password2" placeholder="••••••••" required>
                        </div>
                    </div>
                        {% if erreur %}
                        <p class="error-message" style="margin-bottom: 16px;">{{ erreur }}</p>
                        {% endif %}
                        {% if success %}
                        <p class="success-message" style="margin-bottom: 16px;">{{ success }}</p>
                        {% endif %}
                    <button class="btn-primary" type="submit">
                        Mettre à jour le mot de passe
                    </button>
                </form>
            </div>

            <!-- Changer le préfixe API -->
            <div class="login-card settings-card">
                <h2>Changer le préfixe API</h2>
                <p class="description">Changez le préfixe utilisé pour les appels API.</p>
                <p class="description">Ancien préfixe : {{ api_prefix }}</p>
                <form method="post">
                    <input type="hidden" name="action" value="changeApiPrefix">
                    <div class="form-group">
                        <label for="new_prefix">Nouveau préfixe API (sans '/')</label>
                        <div class="input-wrapper">
                            <input type="text" id="new_prefix" name="new_prefix" placeholder="nouveau_prefixe" required>
                        </div>
                    </div>
                    {% if api_prefix_erreur %}
                    <p class="error-message" style="margin-bottom: 16px;">{{ api_prefix_erreur }}</p>
                    {% endif %}
                    {% if api_prefix_success %}
                    <p class="success-message" style="margin-bottom: 16px;">{{ api_prefix_success }}</p>
                    {% endif %}
                    <button class="btn-primary" type="submit">
                        Mettre à jour le préfixe API
                    </button>
                </form>
            </div>

            <!-- Exporter / Importer -->
            <div class="login-card settings-card">
                <h2>Exporter / Importer la configuration</h2>
                <p class="description">Exportez le fichier commandes.json actuel ou importez un nouveau JSON pour remplacer la configuration.</p>

                <div class="button-row">
                    <a class="btn-secondary" href="/settings/export">Exporter commandes.json</a>
                </div>

                {% if import_error %}
                <p class="error-message" style="margin-bottom: 16px;">{{ import_error }}</p>
                {% endif %}
                {% if import_success %}
                <p class="success-message" style="margin-bottom: 16px;">{{ import_success }}</p>
                {% endif %}

                <form method="post" enctype="multipart/form-data">
                    <input type="hidden" name="action" value="importCommands">
                    <div class="form-group">
                        <label for="commands_file">Importer un fichier JSON</label>
                        <div class="input-wrapper file-input-wrapper">
                            <input type="file" id="commands_file" name="commands_file" accept=".json" required>
                        </div>
                    </div>
                    <button class="btn-primary" type="submit">Importer le fichier</button>
                </form>
            </div>

            <!-- Exporter les logs -->
            <div class="login-card settings-card">
                <h2>Exporter les logs</h2>
                <p class="description">Exportez les fichiers de logs. Ils seront téléchargés dans une archive ZIP si plusieurs fichiers existent.</p>

                <div class="button-row">
                    <a class="btn-secondary" href="/settings/export-logs">Exporter logs</a>
                </div>
            </div>

            <div class="login-card settings-card">
                <h2>Mode de sécurité</h2>
                <p class="description">Sélectionnez le mode de sécurité pour les accès API.</p>

                <form method="post">
                    <input type="hidden" name="action" value="changeMode">
                    <div class="form-group">
                        <label for="mode">Mode actuel : <strong>{{ current_mode }}</strong></label>
                        <div style="margin: 16px 0;">
                            <label style="display: flex; align-items: center; margin-bottom: 12px; cursor: pointer;">
                                <input type="radio" name="mode" value="WHITELIST" {% if current_mode == 'WHITELIST' %}checked{% endif %} style="margin-right: 8px;">
                                <span>
                                    <strong>Whitelist</strong> - Seules les IPs autorisées peuvent accéder
                                </span>
                            </label>
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="mode" value="BLACKLIST" {% if current_mode == 'BLACKLIST' %}checked{% endif %} style="margin-right: 8px;">
                                <span>
                                    <strong>Blacklist</strong> - Toutes les IPs peuvent accéder sauf celles interdites
                                </span>
                            </label>
                        </div>
                    </div>
                    {% if mode_success %}
                    <p class="success-message" style="margin-bottom: 16px;">{{ mode_success }}</p>
                    {% endif %}
                    {% if mode_erreur %}
                    <p class="error-message" style="margin-bottom: 16px;">{{ mode_erreur }}</p>
                    {% endif %}
                    <button class="btn-primary" type="submit">
                        Mettre à jour le mode
                    </button>
                </form>
            </div>
            {% if current_mode == 'WHITELIST' %}
                <div class="login-card settings-card">
                    <h2>Gestion de la Whitelist</h2>
                    <p class="description">Gérez les IPs autorisées à accéder à l'API en mode Whitelist.</p>

                    <form method="post" style="margin-bottom: 24px;">
                        <input type="hidden" name="action" value="addIp">
                        <input type="hidden" name="list_type" value="whitelist">
                        <div class="form-group">
                            <label for="whitelist_ip">Ajouter une IP</label>
                            <div class="input-wrapper">
                                <input type="text" id="whitelist_ip" name="ip_address" placeholder="192.168.1.100" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="whitelist_desc">Description (optionnel)</label>
                            <div class="input-wrapper">
                                <input type="text" id="whitelist_desc" name="ip_description" placeholder="Ex: Mon serveur">
                            </div>
                        </div>
                        {% if whitelist_error %}
                        <p class="error-message" style="margin-bottom: 16px;">{{ whitelist_error }}</p>
                        {% endif %}
                        {% if whitelist_success %}
                        <p class="success-message" style="margin-bottom: 16px;">{{ whitelist_success }}</p>
                        {% endif %}
                        <button class="btn-primary" type="submit">
                            Ajouter à la Whitelist
                        </button>
                    </form>

                    <div style="margin-top: 16px;">
                        <h3 style="font-size: 0.95em; margin-bottom: 12px;">IPs en Whitelist</h3>
                        {% if whitelist %}
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid #e0e0e0;">
                                    <th style="text-align: left; padding: 8px; font-weight: 600;">IP</th>
                                    <th style="text-align: left; padding: 8px; font-weight: 600;">Description</th>
                                    <th style="text-align: center; padding: 8px; font-weight: 600;">Etat</th>
                                    <th style="text-align: center; padding: 8px; font-weight: 600;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ip_item in whitelist %}
                                <tr style="border-bottom: 1px solid #f0f0f0;">
                                    <td style="padding: 12px 8px; font-family: monospace;">{{ ip_item.ip }}</td>
                                    <td style="padding: 12px 8px;">{{ ip_item.description or '-' }}</td>
                                    <td style="text-align: center; padding: 12px 8px;">
                                        <form method="post" style="display: inline;">
                                            <input type="hidden" name="action" value="toggleIp">
                                            <input type="hidden" name="list_type" value="whitelist">
                                            <input type="hidden" name="ip_id" value="{{ ip_item.id }}">
                                            <label class="toggle-switch" title="Activer/Désactiver">
                                                <input type="checkbox" {% if ip_item.active %}checked{% endif %} onchange="this.form.submit()">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </form>
                                    </td>
                                    <td style="text-align: center; padding: 12px 8px;">
                                        <form method="post" style="display: inline;">
                                            <input type="hidden" name="action" value="removeIp">
                                            <input type="hidden" name="list_type" value="whitelist">
                                            <input type="hidden" name="ip_id" value="{{ ip_item.id }}">
                                            <button type="submit" class="btn-danger" style="padding: 4px 8px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;" title="Supprimer">Supprimer</button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <p style="color: #999; font-style: italic;">Aucune IP dans la whitelist</p>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            {% if current_mode == 'BLACKLIST' %}
                <div class="login-card settings-card">
                    <h2>Gestion de la Blacklist</h2>
                    <p class="description">Gérez les IPs interdites d'accès à l'API en mode Blacklist.</p>

                    <form method="post" style="margin-bottom: 24px;">
                        <input type="hidden" name="action" value="addIp">
                        <input type="hidden" name="list_type" value="blacklist">
                        <div class="form-group">
                            <label for="blacklist_ip">Ajouter une IP</label>
                            <div class="input-wrapper">
                                <input type="text" id="blacklist_ip" name="ip_address" placeholder="192.168.1.100" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="blacklist_desc">Description (optionnel)</label>
                            <div class="input-wrapper">
                                <input type="text" id="blacklist_desc" name="ip_description" placeholder="Ex: Ordinateur indésirable">
                            </div>
                        </div>
                        {% if blacklist_error %}
                        <p class="error-message" style="margin-bottom: 16px;">{{ blacklist_error }}</p>
                        {% endif %}
                        {% if blacklist_success %}
                        <p class="success-message" style="margin-bottom: 16px;">{{ blacklist_success }}</p>
                        {% endif %}
                        <button class="btn-primary" type="submit">
                            Ajouter à la Blacklist
                        </button>
                    </form>

                    <div style="margin-top: 16px;">
                        <h3 style="font-size: 0.95em; margin-bottom: 12px;">IPs en Blacklist</h3>
                        {% if blacklist %}
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid #e0e0e0;">
                                    <th style="text-align: left; padding: 8px; font-weight: 600;">IP</th>
                                    <th style="text-align: left; padding: 8px; font-weight: 600;">Description</th>
                                    <th style="text-align: center; padding: 8px; font-weight: 600;">Etat</th>
                                    <th style="text-align: center; padding: 8px; font-weight: 600;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ip_item in blacklist %}
                                <tr style="border-bottom: 1px solid #f0f0f0;">
                                    <td style="padding: 12px 8px; font-family: monospace;">{{ ip_item.ip }}</td>
                                    <td style="padding: 12px 8px;">{{ ip_item.description or '-' }}</td>
                                    <td style="text-align: center; padding: 12px 8px;">
                                        <form method="post" style="display: inline;">
                                            <input type="hidden" name="action" value="toggleIp">
                                            <input type="hidden" name="list_type" value="blacklist">
                                            <input type="hidden" name="ip_id" value="{{ ip_item.id }}">
                                            <label class="toggle-switch" title="Activer/Désactiver">
                                                <input type="checkbox" {% if ip_item.active %}checked{% endif %} onchange="this.form.submit()">
                                                <span class="toggle-slider"></span>
                                            </label>
                                        </form>
                                    </td>
                                    <td style="text-align: center; padding: 12px 8px;">
                                        <form method="post" style="display: inline;">
                                            <input type="hidden" name="action" value="removeIp">
                                            <input type="hidden" name="list_type" value="blacklist">
                                            <input type="hidden" name="ip_id" value="{{ ip_item.id }}">
                                            <button type="submit" class="btn-danger" style="padding: 4px 8px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;" title="Supprimer">Supprimer</button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <p style="color: #999; font-style: italic;">Aucune IP dans la blacklist</p>
                        {% endif %}
                    </div>
                </div>
            {% endif %}


        </div>
        <footer style="font-size: 0.8em; color: #999; text-align: center;">
            Version {{ config.APP_VERSION }}
        </footer>
    </main>

</body>
</html>